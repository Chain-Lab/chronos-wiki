# 2022.12 测试文档

2022年12月的测试文档，截止到测试文档编写前tps达到40

![](https://imgs.decision01.com/202212221506857.png ':size=70%')

上图的测试方案：开启5台云服务器进行测试，通过批量交易的方式发送代币到2000个测试账户中。然后，由本地模拟这2000个钱包发送交易，在多线程的情况下发送。最初测试时发送的交易数量较多，但是随着时间的推移发送的有效交易数量降低。

## 测试方案 v1

为了更好地测试 tps，开启10台服务器并运行 chronos 服务，这10台服务器共同维护一条链。根据原来的测试，一台服务器上可以运行较多的线程，那么每台服务器设置大小为50的线程进行交易的发送。

根据原来的测试结果，使用外网带宽测试的开销较大，本次测试在内网进行，避开使用外网上下行流量带来的额外开销。

![](https://imgs.decision01.com/202212221540243.png ':size=50%')

为了便于测试，发送交易的节点需要一个命令行工具来完成测试，命令行工具命令需求：

* 生成钱包：根据指令生成公私钥对并保存到文件中
* 发送utxo：通过私钥从一个账户下分发utxo到生成的钱包地址
* 进行测试：开启线程池以及任务，读取生成的钱包然后发送交易到节点中
* 下载测试文件：从对象存储中下载测试文件，测试文件中包含了节点ip地址，端口默认
* 生成本地地址：生成本地的钱包地址，并且上报到指定的位置，便于归集

各个节点在初始化时使用生成钱包的指令，生成指定数量的钱包。然后对 UTxO 的分发如下，由创世钱包通过一笔交易将 UTxO 分发给各个节点。再由各个节点通过批量交易的方式，每批500个钱包分发（交易过大会超过 rpc 最大传输限制）。在完成分发后，启动各个节点的测试，对区块链节点中发送交易开始测试。

![](https://imgs.decision01.com/202212231113077.png ':size=50%')

### 地址归集

由于目前还没有对 UTxO 已被使用的情况进行处理，所以需要使用创世钱包先分发到各节点，然后由这些节点依次分发到本地生成的钱包中

最终每个钱包中分发代币数量为 10000, 那么分发到每个节点的代币数量为 10,0000,000，需要设置创世节点的奖励数量为 100,000,000 以上

使用 flask 聚合数据，每个节点在初始化时生成唯一标识符，然后访问基于 flask 的服务来上报自己的地址

上报传送数据格式：

```
url: /submit_address
data: {
	"id": "",
	"address": ""
}
```

然后访问对应服务器下的`/addresses`来得到一个 json 格式的地址列表，后续便于发送 UTxO 到这些地址

## 测试日志

### 2022/12/22

完成了 `测试方案 v1` 的基本代码实现后开始进行测试，但是测试过程中发现在分离的 utxo 在达到一定数量后会导致节点无法继续产生新的区块

但是，在修改日志级别为 DEBUG 后，能够正常生成区块。但是这是矛盾的，如果降低日志级别会带来处理速度的降低（日志 I/O 带来了较大的 cpu 开销），需要查明原因后进行测试。

### 2022/12/23

修复了区块产生的问题后，重新进行测试，目前达到tps为60

![block-time-result-1671787106.7916877](https://imgs.decision01.com/202212231819039.png ':size=50%')

根据目前的测试得到的数据，区块产生分为三个阶段：共识投票、打包区块、广播存储

共识投票花费3~5s的时间，打包区块0.7ms一笔交易，在2000笔交易的情况下耗费1.5s

广播存储的时间和区块大小相关，2000笔交易的区块存储耗时约5s，待处理问题：

- [ ] 对共识投票机制的处理，目前的共识投票机制是：每个节点发送自身的投票信息给邻居节点，然后收到邻居节点的信息后合并信息，直到所有邻居的投票信息和自身一致后，认为共识完成
- [ ] 打包区块的优化，目前2000笔交易在不验证的情况下从队列取出的速度过慢，需要查找原因并优化
- [ ] 广播存储需要移出这个过程，目前的存储区块是耗费 CPU 时间的，它和共识是没有关系的，考虑后续将这个过程异步化或者通过缓存来进行处理

