# 线程协作

为了协调多个 client 和 server 线程，需要有单例来收集信息并且处理

在 v1.0.4 版本中添加了投票中心 VoteCenter来处理投票信息，在移除投票线程后需要新的单例来协调线程之间的信息互通

## 线程

在修改了通信协议后，新增了 Manager 线程来收集新打包的区块、对端节点发来的新区块，以及广播区块到各个邻居节点。为了加速插入区块，将对 UTxO 的更新专门给一个线程负责，并且在打包区块时暂停对区块的更新。这样，在更新区块时直接提交区块任务而不需要花费时间更新UTxO。（**但是这样依然会占用整体的时间片，后续需要优化。**）区块选择的类 Selector 不需要开启线程，只需要由 Manager 在处理任务时保持选取区块，以及更新状态即可。

在这里说明 Manager、Client、Selector、UTxOSet 在协作需要用到的函数和实现

### Manager

Manager 接收 Client 从对端获取的**已确认区块**和 Server 从对端收到的**待选取区块**进行处理，这两种处理对应了两个函数：

`insert_block`：接收已确认区块，插入到数据库中，对区块的唯一限制是该区块的高度刚好是数据库中的最高区块的下一个。

`append_block`：接收待选取区块，调用选择器 Selector 进行比较选取，在本地的区块未同步完成时选取的区块都不会被插入。

此外，还有其他的函数用来完成其他功能：

`notify_insert`：等待时间结束后，调用 Selector 将优先级最高的区块插入到数据库。

`is_known_block`：由 Server 在收到待选取区块哈希值后，判断该区块在本地是否已经见过。

`get_known_block`：由 Client 在收到对端到拉取待选取区块的请求后，调用该函数得到区块并且返回给对端。

`task`：Manager 的线程函数，从待选取区块队列中取出一个区块，进行广播和比较选取。

`__broadcast`：广播待选取区块，从邻居节点中选取 $\sqrt{n}$ 个发送区块，其他的只广播区块哈希。

### Client

Client 新增了两个队列，待广播区块队列和待广播区块哈希队列，由 Manager 添加区块或区块哈希来触发广播。

和线程协作相关的函数只有一个`shake_loop`，其运行流程如下图所示

![Chronos Documents(5)](https://imgs.decision01.com/202212301211277.jpg)

交易池会记录每次打包的区块高度，在下一个区块未被选出的时候，其他 Client 线程也不会重复打包区块

### Selector

Selector 只是一个用于选取待选取区块的单例，没有线程函数，`compare_block`函数用于开放给 Manager 来比较选取区块

Selector 在每个打包间隔内维护一个`__selected_block`，表示当前的**最优区块**，对区块选取的方式如下：

* 区块的时间戳是否超时，如果超时则直接返回。

  > 对区块超时的定义：
  >
  > 假设创世区块产生的时间戳为$t_0$，区块高度为 $n$ 的待选取区块的时间戳为 $t_n$，区块选取等待延时为 $interval$，那么判断：
  > $$
  > t_0 + interval \cdot t_n< t_n
  > $$
  > 如果满足该不等式则区块超时

* 如果目前最优区块为空，则直接选取当前的待选取区块，否则继续按照下面的步骤对比待选取区块和现在的最优区块

* 对比当前区块和最优区块包含的交易数量，选取交易数量最多的区块

* 如果交易数量一样，对比两者的时间戳，选取时间戳最小的区块

在等待选取时间结束后，Manager 调用 Selector 的 `insert_block` 函数，将最优区块插入数据库。

如果在到达选取时间后没有接收到待选取区块，最优区块为空，则会由 Client 在握手时发现本地已确认区块高度较低，拉取对端的区块由 Manager 进行插入。

### UTxOSet

在插入区块时需要更新 UTxO 集合：对已使用的 UTxO 删除，然后插入新增的 UTxO。这会导致在插入时所有操作都要等待新区块插入，并且 UTxO 插入的耗时较高。

将这部分操作线程化，在 UTxOSet 类下新增一个区块队列，然后在初始化时开启线程等待队列，在队列中有区块时取出区块处理。这样在插入区块时只需要向这个队列中插入任务，而不用由插入区块的线程去处理 UTxO。

